# Netlify Configuration for ChartSense
# Production-ready configuration for full-stack deployment

# =============================================================================
# BUILD SETTINGS
# =============================================================================
[build]
  base = "frontend-react"
  command = "npm ci && npm run build"
  publish = "build"
  functions = "../netlify/functions"

[build.environment]
  # Node.js version for React build
  NODE_VERSION = "18"
  
  # Python version for serverless functions
  PYTHON_VERSION = "3.11"
  
  # React environment variables (embedded at build time)
  REACT_APP_API_URL = "/.netlify/functions"
  REACT_APP_ENABLE_CHAT = "true"
  REACT_APP_ENABLE_RISK_CALCULATOR = "true"
  REACT_APP_VERSION = "1.0.0"
  
  # Secrets scanning configuration (prevent false positives)
  SECRETS_SCAN_OMIT_KEYS = "HF_API_KEY,BACKEND_URL,LOG_LEVEL,VISION_MODEL,REASONING_MODEL,VISION_TIMEOUT,REASONING_TIMEOUT,TOTAL_TIMEOUT,REACT_APP_API_URL"

# =============================================================================
# FUNCTION SETTINGS
# =============================================================================
[functions]
  # Directory containing serverless functions
  directory = "netlify/functions"
  
  # Function runtime
  node_bundler = "esbuild"
  
  # Extend function timeout for AI processing
  # Default is 10s, we need more for AI models
  # Note: Background functions can run up to 15min on Pro plans
  
[[functions.analyze]]
  # Main chart analysis function
  timeout = 120  # 2 minutes for AI processing

# =============================================================================
# REDIRECTS & ROUTING
# =============================================================================

# API routes to serverless functions
[[redirects]]
  from = "/api/analyze"
  to = "/.netlify/functions/analyze"
  status = 200
  force = true

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

# SPA routing - must be last
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# =============================================================================
# HEADERS (Security & Performance)
# =============================================================================

[[headers]]
  for = "/*"
  [headers.values]
    # Security headers
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=()"
    
    # CORS for API endpoints
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type"

[[headers]]
  for = "/api/*"
  [headers.values]
    # API-specific headers
    Cache-Control = "no-cache, no-store, must-revalidate"
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization"
    Access-Control-Max-Age = "3600"

[[headers]]
  for = "/static/*"
  [headers.values]
    # Cache static assets for 1 year
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# =============================================================================
# CONTEXT-SPECIFIC SETTINGS
# =============================================================================

# Production context
[context.production.environment]
  NODE_ENV = "production"
  ENV = "production"

# Deploy previews (pull requests)
[context.deploy-preview.environment]
  NODE_ENV = "development"
  ENV = "staging"

# Branch deploys
[context.branch-deploy.environment]
  NODE_ENV = "development"
  ENV = "staging"

# Development context
[context.develop.environment]
  NODE_ENV = "development"
  ENV = "development"

# =============================================================================
# PLUGINS
# =============================================================================

# Essential monitoring for serverless functions
[[plugins]]
  package = "@netlify/plugin-lighthouse"
  
  [plugins.inputs]
    output_path = "lighthouse-reports"

# =============================================================================
# NOTES
# =============================================================================
# 
# Environment Variables to Set in Netlify Dashboard:
# --------------------------------------------------
# 1. HF_API_KEY (REQUIRED) - Your Hugging Face API key
# 2. LOG_LEVEL (optional) - Default: INFO
# 3. VISION_MODEL (optional) - Default: Qwen/Qwen2.5-VL-7B-Instruct
# 4. REASONING_MODEL (optional) - Default: meta-llama/Llama-3.3-70B-Instruct
# 
# To set environment variables:
# 1. Go to Site Settings > Build & deploy > Environment
# 2. Add variables
# 3. Redeploy site
# 
# =============================================================================
